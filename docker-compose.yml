services:
  user_service:
    build:
      context: ./backend
      dockerfile: ./services/user/deps/Dockerfile
    ports: ["3000:3000"]
    restart: always
    depends_on:
      db: 
        condition: service_healthy
    environment:
      SECRET_KEY: "${SECRET_KEY}"
      DATABASE_URL: "mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}"
    networks: [app-network]

  player_service:
    build:
      context: ./backend
      dockerfile: ./services/player/deps/Dockerfile
    ports: ["3001:3001"]
    restart: always
    depends_on:
      db: 
        condition: service_healthy
    environment:
      SECRET_KEY: "${SECRET_KEY}"
      DATABASE_URL: "mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}"
    networks: [app-network]

  token_service:
    build:
      context: ./backend
      dockerfile: ./services/token/deps/Dockerfile
    ports: ["3002:3002"]
    restart: always
    depends_on:
      db: 
        condition: service_healthy
    environment:
      SECRET_KEY: "${SECRET_KEY}"
      DATABASE_URL: "mysql+pymysql://${DB_USER}:${DB_PASSWORD}@db:3306/${DB_NAME}"
    networks: [app-network]

  # Databases

  db:
    image: mysql:latest
    restart: always
    container_name: db
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_ROOT_PASSWORD}"
      MYSQL_DATABASE: "${DB_NAME}"
      MYSQL_USER: "${DB_USER}"
      MYSQL_PASSWORD: "${DB_PASSWORD}"
    volumes:
      - db_data:/var/lib/mysql
    networks: [ app-network ]
    healthcheck:  
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${DB_USER}", "-p${DB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  load-balancer:
    image: nginx:1.23-alpine
    restart: always
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      user_service:
        condition: service_started
      # player_service:
      #   condition: service_started
      # token_service:
      #   condition: service_started
    networks: [app-network]
    ports: ["80:80"]
          
networks:
  app-network:
    driver: bridge

volumes:
  db_data: